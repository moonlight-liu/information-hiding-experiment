# W-SVD 水印检测使用指南

## 🔍 检测原理

W-SVD水印检测采用**相关性检测方法**，通过比较原始水印模板W和待测水印模板W'的相似度来判断水印存在性。

### 数学原理

1. **原始水印模板**: W = A - C （理论含水印系数 - 原始系数）
2. **待测水印模板**: W' = B - C （待测图像系数 - 原始系数）
3. **空域相关性**: d = (W·W'^T) / (||W||·||W'||)
4. **DCT域相关性**: d^ = corr(DCT(W), DCT(W')) (去除DC分量)

### 检测策略

- **阈值判决**: 相关性值 > 阈值τ → 有水印；否则 → 无水印
- **种子扫描**: 通过扫描不同seed绘制SC图确定最佳阈值

## 🚀 使用方法

### 前提条件

确保以下文件存在：

- 原始图像: `input/girl.jpg`
- 水印图像: `output/girl_watermarked.jpg`

### 方法1: 单次检测（验证特定种子）

```powershell
# 切换到正确目录
cd "g:\information hiding\exp3"

# 使用默认参数检测（seed=1234）
python wsvd_detect.py detect

# 自定义参数检测
python wsvd_detect.py detect --cover input/girl.jpg --test output/girl_watermarked.jpg --alpha 0.5 --seed 1234
```

**预期输出**:

检测 seed=1234 的结果：
  小波系数相关性 corr_coef     = 0.8234
  DCT 后小波系数相关性 corr_DCT = 0.7891

### 方法2: 种子扫描（生成SC图）

```powershell
# 使用默认参数扫描种子1230-1240
python wsvd_detect.py scan

# 自定义扫描范围
python wsvd_detect.py scan --seed-start 1230 --seed-end 1250 --out-plot output/custom_sc.png

# 扫描更大范围查看分布
python wsvd_detect.py scan --seed-start 1 --seed-end 50 --out-plot output/wide_sc.png
```

**预期输出**:

开始种子扫描：seed ∈ [1230, 1240]，alpha=0.5, wavelet=db1, level=1, ratio=0.8
  seed=1230 -> d=0.1234, d^=0.0987
  seed=1231 -> d=0.0876, d^=0.0654
  ...
  seed=1234 -> d=0.8234, d^=0.7891  <-- 正确种子，相关性明显较高
  ...
已保存 SC 图到 output/sc_plot.png

## 📊 结果解释

### 相关性值含义

| 相关性范围 | 含义 | 判决 |
|-----------|------|------|
| > 0.7 | 高度相似，几乎确定有水印 | ✅ 检测到水印 |
| 0.3 ~ 0.7 | 中等相似，可能有水印 | ⚠️ 需要结合阈值判决 |
| < 0.3 | 低相似度，随机水平 | ❌ 无水印 |

### SC图特征

- **有水印图像**: 正确种子处会出现明显的相关性峰值
- **无水印图像**: 所有种子的相关性都维持在较低随机水平
- **最佳阈值**: 通常设置为随机水平的3-5倍标准差

## ⚙️ 参数说明

| 参数 | 默认值 | 说明 | 注意事项 |
|------|--------|------|----------|
| `--cover` | `input/girl.jpg` | 原始封面图像 | 必须与嵌入时一致 |
| `--test` | `output/girl_watermarked.jpg` | 待检测图像 | - |
| `--alpha` | `0.3` | 嵌入强度 | **必须与嵌入时完全一致** |
| `--seed` | `1234` | 随机种子 | **必须与嵌入时完全一致** |
| `--wavelet` | `db1` | 小波类型 | **必须与嵌入时完全一致** |
| `--level` | `1` | 分解层数 | **必须与嵌入时完全一致** |
| `--ratio` | `0.7` | 替换比例 | **必须与嵌入时完全一致** |
| `--seed-start` | `1230` | 扫描起始种子 | 仅scan模式 |
| `--seed-end` | `1240` | 扫描结束种子 | 仅scan模式 |
| `--out-plot` | `output/sc_plot.png` | SC图保存路径 | 仅scan模式 |

## 🎯 实验建议

### 1. 验证水印存在性

```powershell
# 检测刚嵌入的水印图像（应该有很高相关性）
python wsvd_detect.py detect --seed 1234

# 检测原始图像（应该相关性很低）
python wsvd_detect.py detect --cover input/girl.jpg --test input/girl.jpg --seed 1234
```

### 2. 确定检测阈值

```powershell
# 对含水印图像扫描
python wsvd_detect.py scan --test output/girl_watermarked.jpg --out-plot output/watermarked_sc.png

# 对原始图像扫描（作为对照）
python wsvd_detect.py scan --test input/girl.jpg --out-plot output/original_sc.png
```

### 3. 测试鲁棒性

```powershell
# 测试不同强度参数的影响
python wsvd_detect.py detect --alpha 0.1 --seed 1234
python wsvd_detect.py detect --alpha 0.5 --seed 1234
```

## 📈 成功指标

- **正确检测**: 使用正确参数时，相关性 > 0.7
- **抗误检**: 使用错误种子时，相关性 < 0.3  
- **阈值区分**: SC图中正确种子与其他种子有明显差异
- **一致性**: 多次检测结果稳定

## 🔧 故障排除

### 相关性异常低

- 检查参数是否与嵌入时完全一致
- 确认图像路径正确
- 验证图像是否确实含有水印

### SC图无明显峰值

- 待测图像可能不含水印
- 嵌入强度α可能过低
- 检测参数可能错误

现在您可以开始检测实验了！建议先运行单次检测验证，再进行种子扫描分析。
